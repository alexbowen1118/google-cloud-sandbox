<?phpinclude("../../../include/connectATTEND.inc");// database connection parametersextract($_REQUEST);if(!$year){$year=date(Y);}if(!$month){$month=(date(m))-1;}// DEFAULT to previous month//echo "<pre>";print_r($_REQUEST);echo "</pre>";exit;$month=str_pad($month,2,"0",str_pad_left);$menu[r_ytd]="r_ytd.php";$menuM=$month;$menuY=$year;$varQuery="submit=Enter&year=$menuY&month=$menuM";if(!$xls){include("../menu.php");}// ignore menu for Excel exportif($xls=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=NC_State_Park_Attendance.xls');}// Get park totals for calendar year thru specified month$nextMonth=$month+1;$nextMonth=str_pad($nextMonth,2,"0",str_pad_left);if($month=="12"){$findYear=$year+1;$nextMonth="01";}else{$findYear=$year;}$findYearB=$year."0100"; $findYearE=$findYear.$nextMonth."00";$sql = "SELECT park, sum(attend_tot) FROM statswhere year_month_week > '$findYearB' and year_month_week < '$findYearE'group by park order by park";//echo "$sql";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){$parkNameYear[]=$row[0];$parkTotYear[$row[0]]=$row[1];}// Get park totals for PREVIOUS calendar yearif($month=="12"){$findYear=$year+1;$nextMonth="01";}else{$findYear=$year;}$findYearB=($year-1)."0100"; $findYearE=($findYear-1).$nextMonth."00";$sql = "SELECT park, sum(attend_tot) FROM statswhere year_month_week> '$findYearB' and year_month_week < '$findYearE'group by park order by park";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){$parkNamePreYear[]=$row[0];$parkTotPreYear[$row[0]]=$row[1];}//echo "$sql $month $nextMonth";// Uses $parkNameYear for park name$y=$year; $m=$month; $mPad=str_pad($m,2,"0",str_pad_left); $mPad_1=str_pad($m+1,2,"0",str_pad_left);$t=$y.$mPad."01";$mF=strftime("%B",strtotime($t));// Get park totals for current month$startMonth=$y.$mPad."00"; $endMonth=$y.$mPad_1."00";$sql = "SELECT park, sum(attend_tot) FROM statswhere year_month_week > '$startMonth' and year_month_week < '$endMonth'group by park";//echo "$sql";if($source=="pub"){include("../../../include/parkcodes.inc");}$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){$parkNameMonth[]=$row[0];$parkTotMonth[$row[0]]=$row[1];}// Uses $parkNameYear for park name// Get park totals for current month PREVIOUS YEAR$startMonth=($y-1).$mPad."00"; $endMonth=($y-1).$mPad_1."00";$sql = "SELECT park, sum(attend_tot) FROM statswhere year_month_week > '$startMonth' and year_month_week < '$endMonth'group by park";//echo "$sql";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){$parkNameMonthPreY[]=$row[0];$parkTotMonthPreY[$row[0]]=$row[1];}$ly=$y-1; $mon=substr($mF,0,3);if($submit=="Enter"){echo "<body><div align='center'><table border='1' cellpadding='5'>";echo "<tr><th>NC STATE<BR>PARK</th><th>$mF<br>$y</th><th>TOTAL YTD<BR>$mF $y</th><th>$mF<br>$ly</th><th>TOTAL YTD<BR>$mF $ly</th><th>% CHANGE<br>($y/$ly)<br>$mon &nbsp; YTD</th></tr>";for($i=0;$i<count($parkNameYear);$i++){if($source!="pub" and $level>0){$parkLink="<a href='form.php?parkcode=$parkNameYear[$i]&passM=$m&yearPass=$year'>$parkNameYear[$i]</a>";}else{$p=$parkShortName[$parkNameYear[$i]];$parkLink=$p;}$monthPark=number_format($parkTotMonth[$parkNameYear[$i]],0);$monthPreYearPark=number_format($parkTotMonthPreY[$parkNameYear[$i]],0);$yearPark=number_format($parkTotYear[$parkNameYear[$i]],0);$yearParkPreY=number_format($parkTotPreYear[$parkNameYear[$i]],0);$perCentChangeM=number_format((($parkTotMonth[$parkNameYear[$i]]/$parkTotMonthPreY[$parkNameYear[$i]])-1)*100);$perCentChangeY=number_format((($parkTotYear[$parkNameYear[$i]]/$parkTotPreYear[$parkNameYear[$i]])-1)*100);$parkMonthTot=$parkMonthTot+$parkTotMonth[$parkNameYear[$i]];$yearMonthTot=$yearMonthTot+$parkTotYear[$parkNameYear[$i]];$yearPrevTot=$yearPrevTot+$parkTotMonthPreY[$parkNameYear[$i]];$yearPrevTotAll=$yearPrevTotAll+$parkTotPreYear[$parkNameYear[$i]];if(fmod($i,2)==0){$bg=" bgcolor='Silver'";}else{$bg="";}echo "<tr$bg><td align='center'>$parkLink</td><td align='right'>$monthPark</td><td align='right'>$yearPark</td><td align='right'>$monthPreYearPark</td><td align='right'>$yearParkPreY</td><td align='center'>$perCentChangeM% &nbsp; $perCentChangeY%</td></tr>";}$perCentChangeMtot=number_format((($parkMonthTot/$yearPrevTot)-1)*100);$perCentChangeYtot=number_format((($yearMonthTot/$yearPrevTotAll)-1)*100);$parkMonthTot=number_format($parkMonthTot,0);$yearMonthTot=number_format($yearMonthTot,0);$yearPrevTot=number_format($yearPrevTot,0);$yearPrevTotAll=number_format($yearPrevTotAll,0);echo "<tr><td><b>SYSTEMWIDE TOTAL</b></td><td align='right'>$parkMonthTot</td><td align='right'>$yearMonthTot</td><td align='right'>$yearPrevTot</td><td align='right'>$yearPrevTotAll</td><td align='center'>$perCentChangeMtot% &nbsp; $perCentChangeYtot%</td></tr>";echo "</table></div></body>";}echo "</html>";?>